use dep::std::hash::sha256;
use dep::std::hash::sha256_var;
use dep::noir_rsa::bignum::BigNum;
use dep::noir_rsa::bignum::runtime_bignum::BigNumInstance;
use dep::noir_rsa::bignum::fields::Params2048;
use dep::noir_rsa::types::RSA;

mod utils;

type BN2048 = BigNum<18, Params2048>;
type RSA2048 = RSA<BN2048, BigNumInstance<18, Params2048>, 256>;

global MAX_DATA_LENGTH: u32 = 1024;

fn main(
    data: [u8; MAX_DATA_LENGTH],
    data_length: u32,
    pubkey_modulus_limbs: [Field; 18],
    redc_params_limbs: [Field; 18],
    signature_limbs: [Field; 18],
    body_start_index: u32
) {
    let pubkey: BigNumInstance<18, Params2048> = BigNumInstance::new(pubkey_modulus_limbs, redc_params_limbs);

    let data_hash: [u8; 32] = sha256_var(data, data_length as u64);
    let signature: BN2048 = BigNum::from_array(signature_limbs);

    // Verify RSA signature
    let rsa: RSA2048 = RSA {};
    assert(rsa.verify_sha256_pkcs1v15(pubkey, data_hash, signature, 65537));

    assert(data[body_start_index - 1] == 46);
    let decoded: [u8; 768] = utils::jwt_body_decode(data, body_start_index, data_length);

    println(decoded);
}

#[test]
fn test_main() {
    main(
        [101,121,74,104,98,71,99,105,79,105,74,83,85,122,73,49,78,105,73,115,73,109,116,112,90,67,73,54,73,109,81,51,89,106,107,122,79,84,99,51,77,87,69,51,79,68,65,119,89,122,81,120,77,50,89,53,77,68,65,49,77,84,65,120,77,109,81,53,78,122,85,53,79,68,69,53,77,84,90,107,78,122,69,105,76,67,74,48,101,88,65,105,79,105,74,75,86,49,81,105,102,81,46,101,121,74,112,99,51,77,105,79,105,74,111,100,72,82,119,99,122,111,118,76,50,70,106,89,50,57,49,98,110,82,122,76,109,100,118,98,50,100,115,90,83,53,106,98,50,48,105,76,67,74,104,101,110,65,105,79,105,73,50,78,84,81,122,77,68,81,119,78,68,99,119,77,84,85,116,99,122,85,122,78,110,74,114,77,51,74,110,78,88,86,106,90,51,69,52,99,71,115,52,100,68,104,116,97,109,82,50,77,84,65,120,79,87,100,105,77,87,111,117,89,88,66,119,99,121,53,110,98,50,57,110,98,71,86,49,99,50,86,121,89,50,57,117,100,71,86,117,100,67,53,106,98,50,48,105,76,67,74,104,100,87,81,105,79,105,73,50,78,84,81,122,77,68,81,119,78,68,99,119,77,84,85,116,99,122,85,122,78,110,74,114,77,51,74,110,78,88,86,106,90,51,69,52,99,71,115,52,100,68,104,116,97,109,82,50,77,84,65,120,79,87,100,105,77,87,111,117,89,88,66,119,99,121,53,110,98,50,57,110,98,71,86,49,99,50,86,121,89,50,57,117,100,71,86,117,100,67,53,106,98,50,48,105,76,67,74,122,100,87,73,105,79,105,73,120,77,84,99,49,79,68,107,48,78,122,103,51,78,68,107,48,77,84,103,119,77,68,77,48,78,106,69,105,76,67,74,111,90,67,73,54,73,109,70,54,100,71,86,106,99,72,74,118,100,71,57,106,98,50,119,117,89,50,57,116,73,105,119,105,90,87,49,104,97,87,119,105,79,105,74,122,89,87,120,108,90,87,120,65,89,88,112,48,90,87,78,119,99,109,57,48,98,50,78,118,98,67,53,106,98,50,48,105,76,67,74,108,98,87,70,112,98,70,57,50,90,88,74,112,90,109,108,108,90,67,73,54,100,72,74,49,90,83,119,105,98,109,57,117,89,50,85,105,79,105,74,50,100,87,49,111,90,87,104,48,98,122,104,115,73,105,119,105,98,109,74,109,73,106,111,120,78,122,73,50,77,84,89,48,78,106,69,48,76,67,74,117,89,87,49,108,73,106,111,105,85,50,70,115,90,87,86,115,73,70,66,112,89,50,104,108,98,105,73,115,73,110,66,112,89,51,82,49,99,109,85,105,79,105,74,111,100,72,82,119,99,122,111,118,76,50,120,111,77,121,53,110,98,50,57,110,98,71,86,49,99,50,86,121,89,50,57,117,100,71,86,117,100,67,53,106,98,50,48,118,89,83,57,66,81,50,99,52,98,50,78,74,78,84,107,119,77,88,112,88,78,108,86,66,81,48,90,105,97,84,82,112,83,109,53,90,99,49,89,120,79,88,100,86,81,107,74,88,97,107,120,110,97,87,115,49,82,84,65,121,90,108,112,107,82,51,90,78,84,110,78,83,90,69,69,57,99,122,107,50,76,87,77,105,76,67,74,110,97,88,90,108,98,108,57,117,89,87,49,108,73,106,111,105,85,50,70,115,90,87,86,115,73,105,119,105,90,109,70,116,97,87,120,53,88,50,53,104,98,87,85,105,79,105,74,81,97,87,78,111,90,87,52,105,76,67,74,112,89,88,81,105,79,106,69,51,77,106,89,120,78,106,81,53,77,84,81,115,73,109,86,52,99,67,73,54,77,84,99,121,78,106,69,50,79,68,85,120,78,67,119,105,97,110,82,112,73,106,111,105,90,84,108,104,90,84,90,104,90,109,73,120,90,106,78,109,79,68,108,105,89,84,81,50,89,122,100,109,77,71,90,108,77,71,70,108,78,50,77,48,90,84,99,51,78,50,85,51,90,71,77,48,79,83,74,57,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        915,
        [1134320245921500934516865200733121927,634338324761634783763845245009857439,1070478337089268773936730067327038714,1254446317159994859931815609363218756,231221636938451469222989781292051825,835160706885148406124967491550112377,1122221420547810842929831780227034102,506704305960799821834835871953944058,868905384958952557686601416952599699,246238310097381796811607529469359948,409145356625541028393432762775012781,100876574760469586610748346057843749,163076682047769376272009048868107209,1270768037994131283967019741159327237,513563865209816591796185363653864619,864221249733168082760848297003544641,1089735294325752345762108012619475455,192],
        [1168806255959705181209950987749946322,333274691026862528009146732823060640,109827721138874484913865775263836697,1138882215619871831832493727997520595,654677511956142136867687970961806947,128774906453535716397716998601420432,327537757821620974860286749355041793,803069221084797947197041532194607248,1185484697072763022356627336302318573,1129324630614122747059271493549103030,1246688389673928357468459042906271394,101676577495205078277783567322594260,668744505548812062325922807663861508,923334944828904002799524384618561770,31182629640266890413051532846818868,949628758823132453111687548542037557,1172461786514369137112771275368034096,339],
        [747371525414017048954607496667654345,1022143055942223593484033565370829670,440523407131522798970531933920004858,938683451703363814445308861632537903,480231060980881638385141421787246582,140355947377092969396208732067134255,441787130187142456444018804394539526,882595268848914662124810724383924232,358028769196593502873776109640003798,1138412512628162583390855276710119240,502586143886908401219888641811982261,853143456628162540755224387250983302,1079019964028110926440958408670463107,1305640455900307887289661491369834518,966099736189648700400019510803301344,171882374922600447704812810934041486,434185841179857267929448508429773227,91],
        103,
    )
}
